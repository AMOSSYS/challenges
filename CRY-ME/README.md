# CRY-ME: lattice attacks

[ANSSI](https://cyber.gouv.fr/) and [CryptoExperts](https://www.cryptoexperts.com/) collaborated to develop a messaging application called CRY.ME (Cryptographic Messaging) based on the *Matrix* protocol for pedagogic purpose.

The original goal was to challenge the French ITSEFs (Amossys being one of them) on their cryptographic skills.
The application source code was publicly released in 2023 and can be found on the [ANSSI Github repository](https://github.com/anssi-fr/cry-me) with all documentation, including the vulnerabilities introduced.

Some vulnerabilities concern the signature generation based on the Schnorr signature.
We present here two Python scripts to run lattice attacks to retrieve the private key:
- one that exploits a **duplicated part** of the nonce
- one that needs a **single signature**.

The whole context and write-up is given on the [Amossys blog](https://www.amossys.fr/insights/blog-technique/cry-me-private-key-recovery-with-a-single-signature/) for the case of the single signature

## Content

The content is as follows:
- `generate_sample_data/`: source code for a program to generate sample data (using CRY-ME source)
- `scripts`:
  * `lattice_nonce_duplicated_part.py`: lattice attack exploiting the duplicated part of the nonce
  * `lattice_single_signature.py`: lattice attack with a single signature.
  * `ec.py`: custom implementation of elliptic curves in Weierstrass form.

## Usage

### Generating sample data

In the folder `generate_sample_data/`, run:
```
make
```
It will generate a binary `gen_data`.
Its usage is:
```
Usage: gen_sig <NUMBER OF SIGNATURES> <OUTPUT FILE NAME>
```
It will generate a file containing signatures generated by a new private key.
The output file contains the public key as a comment (also the private key for information).

### Lattice attack for duplicate part of the nonce

Run the script `lattice_nonce_duplicated_part.py` with the following arguments:
```
- public key in hexadecimal
- file name of signatures
- bit length of secret key
```

Example:
```
$ python3 lattice_nonce_duplicated_part.py 488
c5b8d6b7f11ddb4a9bf48d6f4c75da4b4946308919d003efac70b2e3ad297503eff478191a99bd992fafba3b8bfc5332573fe779d04141580018fa9cb9a31 sample_data.txt 128 -v
```
The result is:
```
Public key: (0 x488c5b8d6b7f11ddb4a9bf48d6f4c75da4b4946308919d003efac70b2e3ad297 , 0
x503eff478191a99bd992fafba3b8bfc5332573fe779d04141580018fa9cb9a31 )
Row: (0, 0, 0, 98231710539662202293445845030608568320 , -590650499391755067980611471139667968 , -133162105914316371907092385627052703744 ,
106607087345710694828821690818448326656 , 146446396706935920300266818048370933760 , 35837196015980688177266585983118213120 ,
151118537561197290253461061010454478848 , 308249794246319705501869046673105223680 , 5170536925074519253662830828414042112 ,
163360048415825977002375561652211113954 , 340282366920938463463374607431768211456)
Private key: 0 x7ae6003ab95f309c4715169717b55fe2
```

The verbose mode with `-v` prints the row of the reduced matrix that contains the private key (in its penultimate coordinate).

### Lattice attack with a single signature

Run the script `lattice_single_signature.py` with the following arguments:
- public key (hexadecimal or base64)
- signature (hexadecimal or base64)

Example:
```bash
$ python3 break_schnorr.py IzGmYC1fTu3AEtHWR2oQMP0YiXIUYl1AWBXZ/6eSFYZCdWtgP7CUYuGVnOLPDOFT6uEb8vE5eXxYrc1RVgZEOg== r5ysPYgq//ztVNhMsiXoG3L6gDVwm0eGYvhIB8u8N4wGHP4firfbbMGJM7bxtQ4s94HqlCkcMIsXf8i91sGRnw==
```

The result is:
```
Public key: (0x2331a6602d5f4eedc012d1d6476a1030fd18897214625d405815d9ffa7921586, 0x42756b603fb09462e1959ce2cf0ce153eae11bf2f139797c58adcd515606443a)
Private key: 0xdfd421d217a6fd0db1629b9e1adade3
```
